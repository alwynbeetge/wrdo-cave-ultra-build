"use strict";(()=>{var e={};e.id=706,e.ids=[706],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},81171:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>z,patchFetch:()=>q,requestAsyncStorage:()=>A,routeModule:()=>b,serverHooks:()=>T,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{GET:()=>f,POST:()=>k,PUT:()=>w,dynamic:()=>x});var a=r(79182),n=r(72007),o=r(56719),i=r(93442),u=r(11826),c=r(83178),d=r(47525),l=r(85698),p=r(92896),m=r(37200),g=r(64561);let x="force-dynamic",h=g.z.object({agentId:g.z.string().min(1,"Agent ID is required"),task:g.z.string().min(10,"Task description must be at least 10 characters").max(2e3,"Task description too long"),justification:g.z.string().min(20,"Justification must be at least 20 characters").max(1e3,"Justification too long"),maxExecutionTime:g.z.number().min(5).max(120).optional()}),v=g.z.object({requestId:g.z.string().uuid("Invalid request ID"),approved:g.z.boolean(),approvalNotes:g.z.string().max(500,"Approval notes too long").optional()});async function k(e){let t=Date.now(),r=(0,p.XQ)(e);try{let s=await (0,u.y_)();if(!s)return i.NextResponse.json({error:"Unauthorized"},{status:401});let a=await (0,l.Iy)(e,l.v1,s.user.id);if(!a.allowed)return i.NextResponse.json({error:"Too many agent requests. Please slow down."},{status:429,headers:a.headers});let n=await e.json(),o=(0,d.b0)(h,n);if(!o.success)return i.NextResponse.json({error:o.error},{status:400,headers:a.headers});let{agentId:g,task:x,justification:v,maxExecutionTime:k}=o.data;if(!m.$C[g])return i.NextResponse.json({error:"Invalid agent ID"},{status:400,headers:a.headers});let w=await m.eF.requestAgentExecution(g,x,{userId:s.user.id,justification:v,maxExecutionTime:k}),f=await c._.deepAgentTask.create({data:{title:`Agent Request: ${m.$C[g].name}`,description:x,taskType:"agent_execution",briefing:{agentId:g,task:x,justification:v,estimatedCost:w.estimatedCost,estimatedTime:w.estimatedTime,riskLevel:w.riskLevel},status:"pending",estimatedCost:w.estimatedCost,userId:s.user.id}});return await p.rO.logActivity({ip:r.ip,userAgent:r.userAgent,userId:s.user.id,action:"agent_request_created",resource:"agent",details:{agentId:g,taskId:f.id,estimatedCost:w.estimatedCost,riskLevel:w.riskLevel},success:!0,responseTime:Date.now()-t}),i.NextResponse.json({requestId:f.id,approvalRequest:w,message:"Agent request created successfully. Awaiting approval."},{headers:a.headers})}catch(s){console.error("Agent request error:",s);let e=await (0,u.y_)().catch(()=>null);return await p.rO.logActivity({ip:r.ip,userAgent:r.userAgent,userId:e?.user.id,action:"agent_request_error",resource:"agent",success:!1,errorMessage:s instanceof Error?s.message:"Unknown error",responseTime:Date.now()-t}),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function w(e){let t=Date.now(),r=(0,p.XQ)(e);try{let s=await (0,u.y_)();if(!s)return i.NextResponse.json({error:"Unauthorized"},{status:401});if(!(s.user.email?.includes("admin")||"admin-user"===s.user.id))return await p.rO.logSecurityEvent({type:"admin_action",severity:"medium",ip:r.ip,userAgent:r.userAgent,userId:s.user.id,description:"Unauthorized attempt to approve agent request"}),i.NextResponse.json({error:"Insufficient privileges"},{status:403});let a=await e.json(),n=(0,d.b0)(v,a);if(!n.success)return i.NextResponse.json({error:n.error},{status:400});let{requestId:o,approved:l,approvalNotes:g}=n.data,x=await c._.deepAgentTask.findUnique({where:{id:o},include:{user:!0}});if(!x)return i.NextResponse.json({error:"Agent request not found"},{status:404});if("pending"!==x.status)return i.NextResponse.json({error:"Agent request has already been processed"},{status:400});let h=await c._.deepAgentTask.update({where:{id:o},data:{status:l?"approved":"rejected",approvedAt:l?new Date:null,result:{approvedBy:s.user.id,approvalNotes:g,approvedAt:new Date().toISOString()}}}),k=null;if(l&&x.briefing)try{let e=x.briefing,t={agentId:e.agentId,task:x.description,estimatedCost:e.estimatedCost,estimatedTime:e.estimatedTime,riskLevel:e.riskLevel,justification:e.justification};k=await m.eF.executeApprovedAgentTask(t,!0,s.user.id),await c._.deepAgentTask.update({where:{id:o},data:{status:"completed",actualCost:k.cost,completedAt:new Date,result:{...h.result||{},executionResult:{content:k.content,model:k.model,provider:k.provider,tokensUsed:k.tokensUsed,cost:k.cost,processingTime:k.processingTime}}}})}catch(e){console.error("Agent execution error:",e),await c._.deepAgentTask.update({where:{id:o},data:{status:"failed",result:{...h.result||{},error:e instanceof Error?e.message:"Execution failed"}}})}return await p.rO.logActivity({ip:r.ip,userAgent:r.userAgent,userId:s.user.id,action:l?"agent_request_approved":"agent_request_rejected",resource:"agent",details:{requestId:o,targetUserId:x.userId,approvalNotes:g,executionResult:k?{cost:k.cost,tokensUsed:k.tokensUsed}:null},success:!0,responseTime:Date.now()-t}),i.NextResponse.json({success:!0,approved:l,message:l?"Agent request approved and executed":"Agent request rejected",executionResult:k})}catch(s){console.error("Agent approval error:",s);let e=await (0,u.y_)().catch(()=>null);return await p.rO.logActivity({ip:r.ip,userAgent:r.userAgent,userId:e?.user.id,action:"agent_approval_error",resource:"agent",success:!1,errorMessage:s instanceof Error?s.message:"Unknown error",responseTime:Date.now()-t}),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function f(e){try{if(!await (0,u.y_)())return i.NextResponse.json({error:"Unauthorized"},{status:401});let t=new URL(e.url),r=t.searchParams.get("status"),s=parseInt(t.searchParams.get("limit")||"20"),a=await c._.deepAgentTask.findMany({where:{taskType:"agent_execution",...r&&{status:r}},include:{user:{select:{id:!0,email:!0,name:!0}}},orderBy:{createdAt:"desc"},take:Math.min(s,100)});return i.NextResponse.json({requests:a})}catch(e){return console.error("Get agent requests error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let b=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/chat/agent-request/route",pathname:"/api/chat/agent-request",filename:"route",bundlePath:"app/api/chat/agent-request/route"},resolvedPagePath:"/home/ubuntu/wrdo-cave-fixed/app/app/api/chat/agent-request/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:A,staticGenerationAsyncStorage:y,serverHooks:T}=b,z="/api/chat/agent-request/route";function q(){return(0,o.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:y})}},37200:(e,t,r)=>{r.d(t,{$C:()=>a,eF:()=>o});let s={"gpt-4o":{id:"gpt-4o",name:"GPT-4o",provider:"openai",costPerToken:3e-5,maxTokens:4e3,capabilities:["text","analysis","coding","reasoning"]},"gpt-4-turbo":{id:"gpt-4-turbo",name:"GPT-4 Turbo",provider:"openai",costPerToken:1e-5,maxTokens:4e3,capabilities:["text","analysis","coding"]},"gpt-3.5-turbo":{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",provider:"openai",costPerToken:2e-6,maxTokens:2e3,capabilities:["text","analysis"]},"gemini-pro":{id:"gemini-pro",name:"Gemini Pro",provider:"gemini",costPerToken:1e-6,maxTokens:3e3,capabilities:["text","analysis","reasoning"]},"deepseek-chat":{id:"deepseek-chat",name:"DeepSeek Chat",provider:"deepseek",costPerToken:5e-7,maxTokens:2500,capabilities:["text","coding","math"]}},a={"deep-agent":{id:"deep-agent",name:"DeepAgent",provider:"openai",costPerToken:1e-4,maxTokens:8e3,capabilities:["research","analysis","data-processing","automation"],isAgent:!0,requiresApproval:!0,estimatedCostPerRequest:2.5,description:"Advanced autonomous agent for complex research and analysis tasks",specializedFor:["market-research","competitive-analysis","data-mining","trend-analysis"],riskLevel:"medium",maxExecutionTime:30},"devin-agent":{id:"devin-agent",name:"Devin",provider:"openai",costPerToken:15e-5,maxTokens:12e3,capabilities:["coding","software-development","debugging","architecture"],isAgent:!0,requiresApproval:!0,estimatedCostPerRequest:5,description:"Expert software development agent for complex coding tasks",specializedFor:["full-stack-development","code-review","architecture-design","debugging"],riskLevel:"high",maxExecutionTime:60}};class n{constructor(){if(this.baseUrl="https://apps.abacus.ai",this.apiKey=process.env.ABACUSAI_API_KEY,!this.apiKey)throw Error("ABACUSAI_API_KEY environment variable is required")}async chatCompletion(e,t,r={}){let n=Date.now();if(a[t])throw Error("Agent requests require explicit approval. Use requestAgentExecution() method.");if(!s[t])throw Error(`Unknown model: ${t}`);let o=this.getFallbackChain(t),i=null;for(let t=0;t<o.length;t++){let a=o[t],u=s[a];try{let s=await this.executeModelRequest(e,a,u,r),o=Date.now()-n;return{content:s.content,model:a,provider:u.provider,tokensUsed:s.tokensUsed,cost:s.cost,processingTime:o,fallbackUsed:t>0,fallbackReason:t>0?i?.message:void 0}}catch(e){if(console.error(`Model ${a} failed:`,(i=e instanceof Error?e:Error("Unknown error")).message),t===o.length-1)throw Error(`All AI models failed. Last error: ${i.message}`);continue}}throw Error("Unexpected error in AI router")}getFallbackChain(e){return({"gpt-4o":["gpt-4o","gpt-4-turbo","gemini-pro","deepseek-chat"],"gpt-4-turbo":["gpt-4-turbo","gpt-4o","gemini-pro","deepseek-chat"],"gpt-3.5-turbo":["gpt-3.5-turbo","gemini-pro","deepseek-chat"],"gemini-pro":["gemini-pro","gpt-4-turbo","deepseek-chat"],"deepseek-chat":["deepseek-chat","gemini-pro","gpt-3.5-turbo"]})[e]||[e]}async executeModelRequest(e,t,r,s){let a={model:{"gpt-4o":"gpt-4o","gpt-4-turbo":"gpt-4-turbo-preview","gpt-3.5-turbo":"gpt-3.5-turbo","gemini-pro":"gemini-pro","deepseek-chat":"deepseek-chat"}[t]||"gpt-4.1-mini",messages:e,max_tokens:Math.min(s.maxTokens||r.maxTokens,r.maxTokens),temperature:s.temperature||.7,...s.userId&&{user:s.userId}},n=await fetch(`${this.baseUrl}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(a)});if(!n.ok){let e=await n.text();throw Error(`API request failed: ${n.status} ${n.statusText} - ${e}`)}let o=await n.json();if(!o.choices||!o.choices[0]||!o.choices[0].message)throw Error("Invalid API response format");let i=o.choices[0].message.content,u=o.usage?.total_tokens||0,c=u*r.costPerToken;return{content:i,tokensUsed:u,cost:c}}async requestAgentExecution(e,t,r){let s=a[e];if(!s)throw Error(`Unknown agent: ${e}`);let n=this.analyzeTaskComplexity(t);return{agentId:e,task:t,estimatedCost:s.estimatedCostPerRequest*n.multiplier,estimatedTime:Math.min(s.maxExecutionTime*n.multiplier,r.maxExecutionTime||s.maxExecutionTime),riskLevel:s.riskLevel,justification:r.justification}}async executeApprovedAgentTask(e,t,r){if(!t)throw Error("Agent execution was not approved");let s=a[e.agentId];if(!s)throw Error(`Unknown agent: ${e.agentId}`);let n=Date.now(),o=[{role:"system",content:this.createAgentSystemPrompt(s,e.task)},{role:"user",content:e.task}];try{let t=await this.executeModelRequest(o,"gpt-4o",{...s,maxTokens:s.maxTokens},{maxTokens:s.maxTokens}),r=Date.now()-n;return{content:t.content,model:e.agentId,provider:s.provider,tokensUsed:t.tokensUsed,cost:t.cost,processingTime:r}}catch(e){throw Error(`Agent execution failed: ${e instanceof Error?e.message:"Unknown error"}`)}}analyzeTaskComplexity(e){let t=e.toLowerCase(),r="simple",s=1,a=["research","analyze","comprehensive","detailed","market analysis","competitive analysis","full stack","architecture","multi-step","integration","automation","workflow"].filter(e=>t.includes(e)).length,n=["review","summarize","compare","list","explain","debug","optimize"].filter(e=>t.includes(e)).length;return a>=2||t.length>500?(r="complex",s=2.5):(a>=1||n>=2||t.length>200)&&(r="moderate",s=1.5),{multiplier:s,complexity:r}}createAgentSystemPrompt(e,t){return`You are ${e.name}, ${e.description}.

Your specialized capabilities include: ${e.specializedFor.join(", ")}.

IMPORTANT GUIDELINES:
- Provide comprehensive, professional analysis
- Use structured formatting with clear sections
- Include actionable recommendations
- Be thorough but concise
- Cite sources when making claims
- Acknowledge limitations or assumptions

Risk Level: ${e.riskLevel.toUpperCase()}
Max Execution Time: ${e.maxExecutionTime} minutes

Current Task: ${t}

Provide a detailed, well-structured response that maximizes value for the user.`}getAvailableModels(){return[...Object.values(s),...Object.values(a)]}getModel(e){return s[e]||a[e]||null}isAgent(e){return!!a[e]}}let o=new n},47525:(e,t,r)=>{r.d(t,{H3:()=>i,b0:()=>o,dm:()=>a,jg:()=>n});var s=r(64561);let a=s.z.object({email:s.z.string().email("Invalid email address").min(1,"Email is required").max(255,"Email too long"),password:s.z.string().min(8,"Password must be at least 8 characters").max(128,"Password too long")});s.z.object({name:s.z.string().min(1,"Name is required").max(100,"Name too long").regex(/^[a-zA-Z\s]+$/,"Name can only contain letters and spaces"),email:s.z.string().email("Invalid email address").min(1,"Email is required").max(255,"Email too long"),password:s.z.string().min(8,"Password must be at least 8 characters").max(128,"Password too long").regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,"Password must contain at least one lowercase letter, one uppercase letter, and one number")});let n=s.z.object({message:s.z.string().min(1,"Message cannot be empty").max(8e3,"Message too long"),model:s.z.string().min(1,"Model selection is required").max(50,"Model name too long"),conversationId:s.z.string().uuid("Invalid conversation ID").optional(),temperature:s.z.number().min(0).max(2).optional().default(.7),maxTokens:s.z.number().min(1).max(4e3).optional().default(1e3)});function o(e,t){try{let r=e.parse(t);return{success:!0,data:r}}catch(e){if(e instanceof s.z.ZodError)return{success:!1,error:e.errors[0].message};return{success:!1,error:"Validation failed"}}}function i(e){return e.toLowerCase().trim()}s.z.object({filename:s.z.string().min(1,"Filename is required").max(255,"Filename too long").regex(/^[^<>:"/\\|?*]+$/,"Invalid filename characters"),fileType:s.z.enum(["pdf","docx","txt","csv","xlsx"]).describe("Supported file types"),fileSize:s.z.number().min(1,"File cannot be empty").max(10485760,"File size cannot exceed 10MB")}),s.z.object({action:s.z.enum(["ban_user","unban_user","delete_user","change_role"]),targetUserId:s.z.string().uuid("Invalid user ID"),reason:s.z.string().min(1,"Reason is required").max(500,"Reason too long"),newRole:s.z.enum(["admin","user"]).optional()}),s.z.object({ip:s.z.string().ip("Invalid IP address"),userAgent:s.z.string().max(1e3,"User agent too long"),action:s.z.string().min(1,"Action is required").max(100,"Action too long"),resource:s.z.string().min(1,"Resource is required").max(100,"Resource too long"),details:s.z.record(s.z.any()).optional()}),s.z.object({windowMs:s.z.number().min(1e3).max(36e5),maxRequests:s.z.number().min(1).max(1e4),skipSuccessfulRequests:s.z.boolean().optional().default(!1),skipFailedRequests:s.z.boolean().optional().default(!1)}),s.z.string().uuid("Invalid UUID format"),s.z.string().email("Invalid email address"),s.z.string().min(8,"Password must be at least 8 characters")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[372,609,264,103,561,533],()=>r(81171));module.exports=s})();