exports.id=6997,exports.ids=[6997],exports.modules={39697:()=>{},62302:()=>{},30107:()=>{},47524:()=>{},90455:(e,t,i)=>{"use strict";i.d(t,{ed:()=>c,sd:()=>m,y_:()=>d}),i(98691);var a=i(71615),s=i(86890),n=i(41463);let o=new TextEncoder().encode(process.env.JWT_SECRET||"wrdo-cave-ultra-dev-secret-key-2025");async function r(e){return await new s.N({userId:e.id,email:e.email,name:e.name,image:e.image}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("30d").sign(o)}async function l(e){try{let{payload:t}=await (0,n._)(e,o);return{id:t.userId,email:t.email,name:t.name,image:t.image,createdAt:new Date,updatedAt:new Date}}catch(e){return console.error("JWT verification failed:",e),null}}async function c(e){let t=await r(e),i=new Date(Date.now()+2592e6);return(0,a.cookies)().set("session-token",t,{expires:i,httpOnly:!0,secure:!0,sameSite:"lax",path:"/"}),t}async function d(){try{let e=a.cookies().get("session-token")?.value;if(!e)return null;let t=await l(e);if(!t)return null;return{user:t,expires:new Date(Date.now()+2592e6)}}catch(e){return console.error("Error getting current session:",e),null}}async function m(){(0,a.cookies)().set("session-token","",{expires:new Date(0),httpOnly:!0,secure:!0,sameSite:"lax",path:"/"})}},9487:(e,t,i)=>{"use strict";i.d(t,{_:()=>s});var a=i(53524);let s=globalThis.prisma??new a.PrismaClient},94034:(e,t,i)=>{"use strict";i.d(t,{bX:()=>r,z2:()=>c});var a=i(97816),s=i(9487),n=i(79097);class o{constructor(){this.isInitialized=!1,this.initializeGmail()}async initializeGmail(){try{this.oauth2Client=new a.lkr.auth.OAuth2(process.env.GMAIL_CLIENT_ID,process.env.GMAIL_CLIENT_SECRET,process.env.GMAIL_REDIRECT_URI||"http://localhost:3000/api/auth/gmail/callback");let e=process.env.GMAIL_REFRESH_TOKEN;e&&this.oauth2Client.setCredentials({refresh_token:e}),this.gmail=a.lkr.gmail({version:"v1",auth:this.oauth2Client}),this.isInitialized=!0,console.log("‚úÖ Gmail API initialized successfully")}catch(e){console.error("‚ùå Gmail API initialization failed:",e)}}getAuthUrl(){return this.oauth2Client.generateAuthUrl({access_type:"offline",scope:["https://www.googleapis.com/auth/gmail.readonly","https://www.googleapis.com/auth/gmail.modify"],prompt:"consent"})}async exchangeCodeForTokens(e){try{let{tokens:t}=await this.oauth2Client.getToken(e);return this.oauth2Client.setCredentials(t),t.refresh_token&&console.log("\uD83D\uDD10 Refresh token received - store securely"),t}catch(e){throw console.error("Token exchange failed:",e),e}}async getRecentEmails(e,t=50){if(!this.isInitialized)throw Error("Gmail API not initialized");try{let i=await s._.emailAccount.findFirst({where:{userId:e,isActive:!0}});if(!i)throw Error("No active email account found");let a=(await this.gmail.users.messages.list({userId:"me",maxResults:t,q:"is:unread OR newer_than:1d"})).data.messages||[],n=[];for(let t of a)try{let a=await this.gmail.users.messages.get({userId:"me",id:t.id,format:"full"}),s=await this.processEmailMessage(a.data);n.push(s),await this.storeEmailSummary(i.id,s);let o=await this.analyzeForAlerts(s);o&&await this.sendEmailAlert(e,o)}catch(e){console.error(`Failed to process message ${t.id}:`,e)}return n}catch(e){throw console.error("Failed to fetch emails:",e),e}}async processEmailMessage(e){let t=e.payload.headers||[],i=this.getHeader(t,"Subject")||"No Subject",a=this.getHeader(t,"From")||"Unknown Sender",s=this.getHeader(t,"To")||"Unknown Recipient",n=new Date(parseInt(e.internalDate)),o=a.match(/<(.+?)>/),r=o?o[1]:a,l=this.extractEmailContent(e.payload),c=l.substring(0,200)+(l.length>200?"...":""),d=await this.analyzePriority(i,a,l),m=await this.analyzeEmailContent(i,l,a);return{id:e.id,subject:i,sender:a,senderEmail:r,recipient:s,preview:c,fullContent:l,priority:d,isRead:!e.labelIds.includes("UNREAD"),receivedAt:n,labels:e.labelIds,threadId:e.threadId,hasAttachments:this.hasAttachments(e.payload),intelligentSummary:m.summary,actionItems:m.actionItems,sentiment:m.sentiment,category:m.category}}async analyzePriority(e,t,i){let a=e.toLowerCase(),s=i.toLowerCase(),n=t.toLowerCase();return["urgent","asap","immediate","emergency","critical","deadline"].some(e=>a.includes(e)||s.includes(e))?"urgent":["important","priority","meeting","contract","payment","invoice"].some(e=>a.includes(e)||s.includes(e))?"high":["ceo","director","manager","client","customer"].some(e=>n.includes(e))?"high":"normal"}async analyzeEmailContent(e,t,i){try{return t.substring(0,1e3),{summary:`Email from ${i} regarding ${e}`,actionItems:[],sentiment:"neutral",category:"business"}}catch(e){return console.error("AI analysis failed:",e),{summary:`Email from ${i}`,actionItems:[],sentiment:"neutral",category:"other"}}}async analyzeForAlerts(e){let t=[];return"urgent"===e.priority&&t.push({type:"high_priority",email:e,reason:"Email marked as urgent priority",confidence:.9}),["ceo@","director@","manager@"].some(t=>e.senderEmail.includes(t))&&t.push({type:"important_sender",email:e,reason:"Email from important sender",confidence:.8}),["contract","payment","deadline","meeting","urgent"].some(t=>e.subject.toLowerCase().includes(t)||e.fullContent.toLowerCase().includes(t))&&t.push({type:"urgent_keywords",email:e,reason:"Contains urgent keywords",confidence:.7}),t.length>0?t.sort((e,t)=>t.confidence-e.confidence)[0]:null}async sendEmailAlert(e,t){t.email.id,t.email.subject,t.email.sender,t.email.preview,t.type,t.email.id,t.type,t.reason,t.confidence,t.email.sender,t.email.subject,n.p.sendEmailAlert(e,t.email)}async storeEmailSummary(e,t){try{await s._.emailSummary.upsert({where:{id:t.id},update:{subject:t.subject,sender:t.sender,preview:t.preview,priority:t.priority,isRead:t.isRead,receivedAt:t.receivedAt},create:{id:t.id,subject:t.subject,sender:t.sender,preview:t.preview,priority:t.priority,isRead:t.isRead,receivedAt:t.receivedAt,emailAccountId:e}})}catch(e){console.error("Failed to store email summary:",e)}}getHeader(e,t){return e.find(e=>e.name.toLowerCase()===t.toLowerCase())?.value}extractEmailContent(e){let t="";if(e.body?.data)t=Buffer.from(e.body.data,"base64").toString("utf-8");else if(e.parts)for(let i of e.parts)"text/plain"===i.mimeType&&i.body?.data&&(t+=Buffer.from(i.body.data,"base64").toString("utf-8"));return t.replace(/<[^>]*>/g,"").trim()}hasAttachments(e){return!!e.parts&&e.parts.some(e=>e.filename&&e.filename.length>0)}async startEmailMonitoring(e){console.log(`üìß Starting email monitoring for user ${e}`);try{await this.getRecentEmails(e),console.log("‚úÖ Email check completed successfully")}catch(e){console.error("‚ùå Email monitoring failed:",e)}}}let r=new o;class l{startMonitoring(e,t=5){this.intervals.has(e)&&this.stopMonitoring(e);let i=setInterval(async()=>{try{await r.startEmailMonitoring(e)}catch(t){console.error(`Email monitoring failed for user ${e}:`,t)}},6e4*t);this.intervals.set(e,i),console.log(`üìß Email monitoring started for user ${e} (${t}min intervals)`)}stopMonitoring(e){let t=this.intervals.get(e);t&&(clearInterval(t),this.intervals.delete(e),console.log(`üìß Email monitoring stopped for user ${e}`))}stopAllMonitoring(){Array.from(this.intervals.entries()).forEach(([e,t])=>{clearInterval(t)}),this.intervals.clear(),console.log("\uD83D\uDCE7 All email monitoring stopped")}constructor(){this.intervals=new Map}}let c=new l},79097:(e,t,i)=>{"use strict";i.d(t,{p:()=>s}),i(90117);class a{constructor(){this.io=null,this.activeConnections=new Map}static getInstance(){return a.instance||(a.instance=new a),a.instance}initializeIO(e){this.io=e,this.setupEventHandlers(),console.log("\uD83D\uDD0C WRDO WebSocket server initialized")}setupEventHandlers(){this.io&&this.io.on("connection",e=>{console.log(`üîó Client connected: ${e.id}`),e.on("authenticate",t=>{try{this.addUserConnection(t.userId,e.id),e.join(`user:${t.userId}`),e.join("global"),e.emit("authenticated",{success:!0,userId:t.userId,timestamp:new Date}),console.log(`‚úÖ User ${t.userId} authenticated on socket ${e.id}`)}catch(t){e.emit("auth_error",{error:"Authentication failed"})}}),e.on("notification_read",e=>{this.markNotificationRead(e.notificationId,e.userId)}),e.on("agent_status_request",t=>{this.sendAgentStatus(t.agentId,t.userId,e)}),e.on("system_health_request",t=>{this.sendSystemHealth(t,e)}),e.on("disconnect",()=>{this.removeUserConnection(e.id),console.log(`üîå Client disconnected: ${e.id}`)})})}sendNotificationToUser(e,t){return!!this.io&&(this.io.to(`user:${e}`).emit("notification",t),console.log(`üì¨ Notification sent to user ${e}:`,t.title),!0)}sendGlobalNotification(e){return!!this.io&&(this.io.to("global").emit("global_notification",e),console.log(`üì¢ Global notification sent:`,e.title),!0)}sendSystemEvent(e,t){return!!this.io&&(this.io.to(`user:${e}`).emit("system_event",t),console.log(`‚ö° System event sent to user ${e}:`,t.type),!0)}sendAgentCompletion(e,t,i){let a={id:`agent_${t}_${Date.now()}`,type:"agent_complete",title:"Agent Task Completed",message:`Your ${t} agent has completed its task successfully.`,severity:"medium",userId:e,metadata:{agentId:t,result:i},timestamp:new Date,read:!1};this.sendNotificationToUser(e,a)}sendTaskUpdate(e,t,i,a){let s={id:`task_${t}_${Date.now()}`,type:"task_update",title:"Task Status Update",message:`Task ${t} status: ${i}${a?` (${a}%)`:""}`,severity:"low",userId:e,metadata:{taskId:t,status:i,progress:a},timestamp:new Date,read:!1};this.sendNotificationToUser(e,s)}sendEmailAlert(e,t){let i={id:`email_${Date.now()}`,type:"email_alert",title:"Important Email Received",message:`High-priority email from ${t.sender}: ${t.subject}`,severity:"urgent"===t.priority?"critical":"medium",userId:e,metadata:t,timestamp:new Date,read:!1};this.sendNotificationToUser(e,i)}sendSecurityAlert(e,t,i){let a={id:`security_${Date.now()}`,type:"security_event",title:"Security Alert",message:`Security event detected: ${t}`,severity:"high",userId:e,metadata:{eventType:t,details:i},timestamp:new Date,read:!1};this.sendNotificationToUser(e,a)}sendSystemHealth(e,t){let i={timestamp:new Date,status:"healthy",uptime:process.uptime(),memory:process.memoryUsage(),activeConnections:this.activeConnections.size,services:{ai:"operational",database:"operational",email:"operational",websocket:"operational"}};t.emit("system_health",i)}sendAgentStatus(e,t,i){let a={agentId:e,status:"active",lastExecution:new Date,tasksCompleted:Math.floor(100*Math.random()),averageExecutionTime:Math.floor(5e3*Math.random())+1e3,successRate:.95+.05*Math.random()};i.emit("agent_status",a)}addUserConnection(e,t){this.activeConnections.has(e)||this.activeConnections.set(e,[]),this.activeConnections.get(e)?.push(t)}removeUserConnection(e){Array.from(this.activeConnections.entries()).forEach(([t,i])=>{let a=i.indexOf(e);a>-1&&(i.splice(a,1),0===i.length&&this.activeConnections.delete(t))})}async markNotificationRead(e,t){console.log(`‚úÖ Notification ${e} marked as read by user ${t}`)}getActiveConnectionsCount(){return this.activeConnections.size}isUserConnected(e){return this.activeConnections.has(e)}}let s=a.getInstance()}};