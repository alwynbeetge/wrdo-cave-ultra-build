"use strict";(()=>{var e={};e.id=744,e.ids=[744],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},4751:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>T,requestAsyncStorage:()=>b,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{DELETE:()=>k,GET:()=>x,POST:()=>h,PUT:()=>v,dynamic:()=>g});var a=r(49303),o=r(88716),i=r(60670),n=r(87070),c=r(90455),l=r(9487),u=r(60556),d=r(35860),p=r(96773),m=r(48767);let g="force-dynamic";async function h(e){let t=Date.now(),r=(0,p.XQ)(e);try{let s=await (0,c.y_)();if(!s)return await p.rO.logSecurityEvent({type:"suspicious_activity",severity:"medium",ip:r.ip,userAgent:r.userAgent,description:"Unauthorized chat API access attempt"}),n.NextResponse.json({error:"Unauthorized"},{status:401});let a=await (0,d.Iy)(e,d.p8,s.user.id);if(!a.allowed)return await p.rO.logSecurityEvent({type:"rate_limit_exceeded",severity:"medium",ip:r.ip,userAgent:r.userAgent,userId:s.user.id,description:"Chat rate limit exceeded",metadata:{retryAfter:a.retryAfter}}),n.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:a.headers});let o=await e.json(),i=(0,u.b0)(u.jg,o);if(!i.success)return await p.rO.logActivity({ip:r.ip,userAgent:r.userAgent,userId:s.user.id,action:"chat_request",resource:"chat",success:!1,errorMessage:i.error}),n.NextResponse.json({error:i.error},{status:400,headers:a.headers});let{message:g,model:h,conversationId:x,temperature:v,maxTokens:k}=i.data;if(o.userId&&o.userId!==s.user.id)return await p.rO.logSecurityEvent({type:"suspicious_activity",severity:"high",ip:r.ip,userAgent:r.userAgent,userId:s.user.id,description:"Attempted to access chat for different user",metadata:{requestedUserId:o.userId}}),n.NextResponse.json({error:"Unauthorized"},{status:401,headers:a.headers});if(m.eF.isAgent(h))return n.NextResponse.json({error:"Agent requests require approval. Use the agent request flow.",requiresApproval:!0,agentInfo:m.$C[h]},{status:400,headers:a.headers});await p.rO.logActivity({ip:r.ip,userAgent:r.userAgent,userId:s.user.id,action:"chat_request",resource:"chat",details:{model:h,messageLength:g.length,conversationId:x}});let f=[{role:"system",content:`You are an intelligent AI assistant in the WRDO Cave platform. You provide accurate, helpful, and professional responses. 

Current date: ${new Date().toLocaleDateString()}
User: ${s.user.name||s.user.email}

Guidelines:
- Be professional, accurate, and helpful
- Provide detailed responses when appropriate
- For complex queries, break down your response into clear sections
- If you're unsure about something, acknowledge it
- Stay focused on the user's question`},{role:"user",content:g}],b=await m.eF.chatCompletion(f,h,{temperature:v,maxTokens:k,userId:s.user.id,conversationId:x}),w=null;try{w=await l._.chatMessage.create({data:{message:g,response:b.content,userId:s.user.id,metadata:{model:b.model,provider:b.provider,tokensUsed:b.tokensUsed,cost:b.cost,processingTime:b.processingTime,fallbackUsed:b.fallbackUsed,fallbackReason:b.fallbackReason,conversationId:x}}})}catch(e){console.error("Database save error:",e)}return await p.rO.logActivity({ip:r.ip,userAgent:r.userAgent,userId:s.user.id,action:"chat_completed",resource:"chat",details:{model:b.model,provider:b.provider,tokensUsed:b.tokensUsed,cost:b.cost,processingTime:b.processingTime,fallbackUsed:b.fallbackUsed,messageId:w?.id},success:!0,responseTime:Date.now()-t}),n.NextResponse.json({response:b.content,metadata:{model:b.model,provider:b.provider,tokensUsed:b.tokensUsed,cost:b.cost,processingTime:b.processingTime,fallbackUsed:b.fallbackUsed,fallbackReason:b.fallbackReason}},{headers:a.headers})}catch(s){console.error("Chat API error:",s);let e=await (0,c.y_)().catch(()=>null);return await p.rO.logActivity({ip:r.ip,userAgent:r.userAgent,userId:e?.user.id,action:"chat_error",resource:"chat",success:!1,errorMessage:s instanceof Error?s.message:"Unknown error",responseTime:Date.now()-t}),await p.rO.logSecurityEvent({type:"suspicious_activity",severity:"medium",ip:r.ip,userAgent:r.userAgent,userId:e?.user.id,description:"Chat API internal error",metadata:{error:s instanceof Error?s.message:"Unknown error"}}),n.NextResponse.json({error:"Internal server error. Please try again."},{status:500})}}async function x(e){return n.NextResponse.json({error:"Method not allowed"},{status:405})}async function v(e){return n.NextResponse.json({error:"Method not allowed"},{status:405})}async function k(e){return n.NextResponse.json({error:"Method not allowed"},{status:405})}let f=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/api/chat/route"},resolvedPagePath:"/home/ubuntu/wrdo-cave-ultra-build/app/api/chat/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:b,staticGenerationAsyncStorage:w,serverHooks:y}=f,A="/api/chat/route";function T(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:w})}},48767:(e,t,r)=>{r.d(t,{$C:()=>a,eF:()=>i});let s={"gpt-4o":{id:"gpt-4o",name:"GPT-4o",provider:"openai",costPerToken:3e-5,maxTokens:4e3,capabilities:["text","analysis","coding","reasoning"]},"gpt-4-turbo":{id:"gpt-4-turbo",name:"GPT-4 Turbo",provider:"openai",costPerToken:1e-5,maxTokens:4e3,capabilities:["text","analysis","coding"]},"gpt-3.5-turbo":{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",provider:"openai",costPerToken:2e-6,maxTokens:2e3,capabilities:["text","analysis"]},"gemini-pro":{id:"gemini-pro",name:"Gemini Pro",provider:"gemini",costPerToken:1e-6,maxTokens:3e3,capabilities:["text","analysis","reasoning"]},"deepseek-chat":{id:"deepseek-chat",name:"DeepSeek Chat",provider:"deepseek",costPerToken:5e-7,maxTokens:2500,capabilities:["text","coding","math"]}},a={"deep-agent":{id:"deep-agent",name:"DeepAgent",provider:"openai",costPerToken:1e-4,maxTokens:8e3,capabilities:["research","analysis","data-processing","automation"],isAgent:!0,requiresApproval:!0,estimatedCostPerRequest:2.5,description:"Advanced autonomous agent for complex research and analysis tasks",specializedFor:["market-research","competitive-analysis","data-mining","trend-analysis"],riskLevel:"medium",maxExecutionTime:30},"devin-agent":{id:"devin-agent",name:"Devin",provider:"openai",costPerToken:15e-5,maxTokens:12e3,capabilities:["coding","software-development","debugging","architecture"],isAgent:!0,requiresApproval:!0,estimatedCostPerRequest:5,description:"Expert software development agent for complex coding tasks",specializedFor:["full-stack-development","code-review","architecture-design","debugging"],riskLevel:"high",maxExecutionTime:60}};class o{constructor(){if(this.baseUrl="https://apps.abacus.ai",this.apiKey=process.env.ABACUSAI_API_KEY||"mock-abacus-api-key-for-development",!this.apiKey)throw Error("ABACUSAI_API_KEY environment variable is required")}async chatCompletion(e,t,r={}){let o=Date.now();if(a[t])throw Error("Agent requests require explicit approval. Use requestAgentExecution() method.");if(!s[t])throw Error(`Unknown model: ${t}`);let i=this.getFallbackChain(t),n=null;for(let t=0;t<i.length;t++){let a=i[t],c=s[a];try{let s=await this.executeModelRequest(e,a,c,r),i=Date.now()-o;return{content:s.content,model:a,provider:c.provider,tokensUsed:s.tokensUsed,cost:s.cost,processingTime:i,fallbackUsed:t>0,fallbackReason:t>0?n?.message:void 0}}catch(e){if(console.error(`Model ${a} failed:`,(n=e instanceof Error?e:Error("Unknown error")).message),t===i.length-1)throw Error(`All AI models failed. Last error: ${n.message}`);continue}}throw Error("Unexpected error in AI router")}getFallbackChain(e){return({"gpt-4o":["gpt-4o","gpt-4-turbo","gemini-pro","deepseek-chat"],"gpt-4-turbo":["gpt-4-turbo","gpt-4o","gemini-pro","deepseek-chat"],"gpt-3.5-turbo":["gpt-3.5-turbo","gemini-pro","deepseek-chat"],"gemini-pro":["gemini-pro","gpt-4-turbo","deepseek-chat"],"deepseek-chat":["deepseek-chat","gemini-pro","gpt-3.5-turbo"]})[e]||[e]}async executeModelRequest(e,t,r,s){let a={model:{"gpt-4o":"gpt-4o","gpt-4-turbo":"gpt-4-turbo-preview","gpt-3.5-turbo":"gpt-3.5-turbo","gemini-pro":"gemini-pro","deepseek-chat":"deepseek-chat"}[t]||"gpt-4.1-mini",messages:e,max_tokens:Math.min(s.maxTokens||r.maxTokens,r.maxTokens),temperature:s.temperature||.7,...s.userId&&{user:s.userId}},o=await fetch(`${this.baseUrl}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(a)});if(!o.ok){let e=await o.text();throw Error(`API request failed: ${o.status} ${o.statusText} - ${e}`)}let i=await o.json();if(!i.choices||!i.choices[0]||!i.choices[0].message)throw Error("Invalid API response format");let n=i.choices[0].message.content,c=i.usage?.total_tokens||0,l=c*r.costPerToken;return{content:n,tokensUsed:c,cost:l}}async requestAgentExecution(e,t,r){let s=a[e];if(!s)throw Error(`Unknown agent: ${e}`);let o=this.analyzeTaskComplexity(t);return{agentId:e,task:t,estimatedCost:s.estimatedCostPerRequest*o.multiplier,estimatedTime:Math.min(s.maxExecutionTime*o.multiplier,r.maxExecutionTime||s.maxExecutionTime),riskLevel:s.riskLevel,justification:r.justification}}async executeApprovedAgentTask(e,t,r){if(!t)throw Error("Agent execution was not approved");let s=a[e.agentId];if(!s)throw Error(`Unknown agent: ${e.agentId}`);let o=Date.now(),i=[{role:"system",content:this.createAgentSystemPrompt(s,e.task)},{role:"user",content:e.task}];try{let t=await this.executeModelRequest(i,"gpt-4o",{...s,maxTokens:s.maxTokens},{maxTokens:s.maxTokens}),r=Date.now()-o;return{content:t.content,model:e.agentId,provider:s.provider,tokensUsed:t.tokensUsed,cost:t.cost,processingTime:r}}catch(e){throw Error(`Agent execution failed: ${e instanceof Error?e.message:"Unknown error"}`)}}analyzeTaskComplexity(e){let t=e.toLowerCase(),r="simple",s=1,a=["research","analyze","comprehensive","detailed","market analysis","competitive analysis","full stack","architecture","multi-step","integration","automation","workflow"].filter(e=>t.includes(e)).length,o=["review","summarize","compare","list","explain","debug","optimize"].filter(e=>t.includes(e)).length;return a>=2||t.length>500?(r="complex",s=2.5):(a>=1||o>=2||t.length>200)&&(r="moderate",s=1.5),{multiplier:s,complexity:r}}createAgentSystemPrompt(e,t){return`You are ${e.name}, ${e.description}.

Your specialized capabilities include: ${e.specializedFor.join(", ")}.

IMPORTANT GUIDELINES:
- Provide comprehensive, professional analysis
- Use structured formatting with clear sections
- Include actionable recommendations
- Be thorough but concise
- Cite sources when making claims
- Acknowledge limitations or assumptions

Risk Level: ${e.riskLevel.toUpperCase()}
Max Execution Time: ${e.maxExecutionTime} minutes

Current Task: ${t}

Provide a detailed, well-structured response that maximizes value for the user.`}getAvailableModels(){return[...Object.values(s),...Object.values(a)]}getModel(e){return s[e]||a[e]||null}isAgent(e){return!!a[e]}}let i=new o},60556:(e,t,r)=>{r.d(t,{H3:()=>n,b0:()=>i,dm:()=>a,jg:()=>o});var s=r(9133);let a=s.z.object({email:s.z.string().email("Invalid email address").min(1,"Email is required").max(255,"Email too long"),password:s.z.string().min(8,"Password must be at least 8 characters").max(128,"Password too long")});s.z.object({name:s.z.string().min(1,"Name is required").max(100,"Name too long").regex(/^[a-zA-Z\s]+$/,"Name can only contain letters and spaces"),email:s.z.string().email("Invalid email address").min(1,"Email is required").max(255,"Email too long"),password:s.z.string().min(8,"Password must be at least 8 characters").max(128,"Password too long").regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,"Password must contain at least one lowercase letter, one uppercase letter, and one number")});let o=s.z.object({message:s.z.string().min(1,"Message cannot be empty").max(8e3,"Message too long"),model:s.z.string().min(1,"Model selection is required").max(50,"Model name too long"),conversationId:s.z.string().uuid("Invalid conversation ID").optional(),temperature:s.z.number().min(0).max(2).optional().default(.7),maxTokens:s.z.number().min(1).max(4e3).optional().default(1e3)});function i(e,t){try{let r=e.parse(t);return{success:!0,data:r}}catch(e){if(e instanceof s.z.ZodError)return{success:!1,error:e.errors[0].message};return{success:!1,error:"Validation failed"}}}function n(e){return e.toLowerCase().trim()}s.z.object({filename:s.z.string().min(1,"Filename is required").max(255,"Filename too long").regex(/^[^<>:"/\\|?*]+$/,"Invalid filename characters"),fileType:s.z.enum(["pdf","docx","txt","csv","xlsx"]).describe("Supported file types"),fileSize:s.z.number().min(1,"File cannot be empty").max(10485760,"File size cannot exceed 10MB")}),s.z.object({action:s.z.enum(["ban_user","unban_user","delete_user","change_role"]),targetUserId:s.z.string().uuid("Invalid user ID"),reason:s.z.string().min(1,"Reason is required").max(500,"Reason too long"),newRole:s.z.enum(["admin","user"]).optional()}),s.z.object({ip:s.z.string().ip("Invalid IP address"),userAgent:s.z.string().max(1e3,"User agent too long"),action:s.z.string().min(1,"Action is required").max(100,"Action too long"),resource:s.z.string().min(1,"Resource is required").max(100,"Resource too long"),details:s.z.record(s.z.any()).optional()}),s.z.object({windowMs:s.z.number().min(1e3).max(36e5),maxRequests:s.z.number().min(1).max(1e4),skipSuccessfulRequests:s.z.boolean().optional().default(!1),skipFailedRequests:s.z.boolean().optional().default(!1)}),s.z.string().uuid("Invalid UUID format"),s.z.string().email("Invalid email address"),s.z.string().min(8,"Password must be at least 8 characters")}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,5972,5795,9457,9133,764],()=>r(4751));module.exports=s})();