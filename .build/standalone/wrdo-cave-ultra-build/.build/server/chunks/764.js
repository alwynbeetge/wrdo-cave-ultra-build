"use strict";exports.id=764,exports.ids=[764],exports.modules={90455:(e,t,s)=>{s.d(t,{ed:()=>l,sd:()=>u,y_:()=>d}),s(98691);var r=s(71615),i=s(86890),a=s(41463);let n=new TextEncoder().encode(process.env.JWT_SECRET||"wrdo-cave-ultra-dev-secret-key-2025");async function c(e){return await new i.N({userId:e.id,email:e.email,name:e.name,image:e.image}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("30d").sign(n)}async function o(e){try{let{payload:t}=await (0,a._)(e,n);return{id:t.userId,email:t.email,name:t.name,image:t.image,createdAt:new Date,updatedAt:new Date}}catch(e){return console.error("JWT verification failed:",e),null}}async function l(e){let t=await c(e),s=new Date(Date.now()+2592e6);return(0,r.cookies)().set("session-token",t,{expires:s,httpOnly:!0,secure:!0,sameSite:"lax",path:"/"}),t}async function d(){try{let e=r.cookies().get("session-token")?.value;if(!e)return null;let t=await o(e);if(!t)return null;return{user:t,expires:new Date(Date.now()+2592e6)}}catch(e){return console.error("Error getting current session:",e),null}}async function u(){(0,r.cookies)().set("session-token","",{expires:new Date(0),httpOnly:!0,secure:!0,sameSite:"lax",path:"/"})}},9487:(e,t,s)=>{s.d(t,{_:()=>i});var r=s(53524);let i=globalThis.prisma??new r.PrismaClient},96773:(e,t,s)=>{s.d(t,{XQ:()=>a,rO:()=>n});var r=s(9487);class i{async logActivity(e){try{await r._.auditLog.create({data:{userId:e.userId||null,action:e.action,resource:e.resource,details:{...e.details,success:e.success,errorMessage:e.errorMessage,responseTime:e.responseTime},ipAddress:e.ip,userAgent:e.userAgent,createdAt:new Date}})}catch(e){console.error("Failed to log activity:",e)}}async logSecurityEvent(e){try{await r._.securityEvent.create({data:{type:e.type,severity:e.severity,ipAddress:e.ip,userAgent:e.userAgent,userId:e.userId||null,description:e.description,metadata:e.metadata,createdAt:new Date}}),await this.logActivity({ip:e.ip,userAgent:e.userAgent,userId:e.userId,action:"security_event",resource:"system",details:{type:e.type,severity:e.severity,description:e.description,metadata:e.metadata},success:!1})}catch(e){console.error("Failed to log security event:",e)}}async analyzeIpActivity(e,t=60){try{let s=new Date(Date.now()-6e4*t),i=await r._.auditLog.findMany({where:{ipAddress:e,createdAt:{gte:s}},select:{action:!0,resource:!0,details:!0,createdAt:!0},orderBy:{createdAt:"desc"}}),a=i.length,n=i.filter(e=>e.details&&"object"==typeof e.details&&"success"in e.details&&!1===e.details.success).length,c=new Set(i.map(e=>`${e.action}:${e.resource}`)).size,o=0;a>100?o+=3:a>50?o+=2:a>20&&(o+=1);let l=a>0?n/a:0;if(l>.5?o+=4:l>.3?o+=2:l>.1&&(o+=1),c>20?o+=2:c>10&&(o+=1),i.length>=2){let e=[];for(let t=1;t<i.length;t++){let s=i[t-1].createdAt.getTime()-i[t].createdAt.getTime();e.push(s)}let t=e.reduce((e,t)=>e+t,0)/e.length;t<1e3?o+=3:t<5e3&&(o+=1)}let d=o>=5;return{totalRequests:a,failedRequests:n,uniqueEndpoints:c,suspiciousActivity:d,riskScore:Math.min(o,10)}}catch(e){return console.error("Failed to analyze IP activity:",e),{totalRequests:0,failedRequests:0,uniqueEndpoints:0,suspiciousActivity:!1,riskScore:0}}}async getIpGeolocation(e){try{if("unknown"===e||"127.0.0.1"===e||e.startsWith("192.168.")||e.startsWith("10."))return{country:"Local",region:"Local",city:"Local"};let t=new AbortController,s=setTimeout(()=>t.abort(),5e3),r=await fetch(`https://ipapi.co/${e}/json/`,{signal:t.signal});if(clearTimeout(s),!r.ok)throw Error(`HTTP ${r.status}`);let i=await r.json();return{country:i.country_name,region:i.region,city:i.city,isp:i.org,isVpn:i.connection?.type==="vpn"}}catch(e){return console.error("Failed to get IP geolocation:",e),{}}}async getRecentSecurityEvents(e=50){try{return await r._.securityEvent.findMany({take:e,orderBy:{createdAt:"desc"},select:{id:!0,type:!0,severity:!0,ipAddress:!0,userAgent:!0,description:!0,createdAt:!0,metadata:!0}})}catch(e){return console.error("Failed to get recent security events:",e),[]}}async getSuspiciousIps(){try{let e=new Date(Date.now()-864e5),t=await r._.auditLog.groupBy({by:["ipAddress"],where:{createdAt:{gte:e},ipAddress:{not:null}},_count:{id:!0},_max:{createdAt:!0}}),s=[];for(let e of t){if(!e.ipAddress)continue;let t=await this.analyzeIpActivity(e.ipAddress,1440);t.suspiciousActivity&&s.push({ip:e.ipAddress,riskScore:t.riskScore,totalRequests:t.totalRequests,failedRequests:t.failedRequests,lastActivity:e._max.createdAt})}return s.sort((e,t)=>t.riskScore-e.riskScore)}catch(e){return console.error("Failed to get suspicious IPs:",e),[]}}}function a(e){let t=e.headers.get("x-forwarded-for"),s=e.headers.get("x-real-ip"),r=e.headers.get("cf-connecting-ip"),i="unknown";return t?i=t.split(",")[0].trim():s?i=s:r?i=r:e.ip&&(i=e.ip),{ip:i,userAgent:e.headers.get("user-agent")||"unknown",referer:e.headers.get("referer")||void 0,origin:e.headers.get("origin")||void 0,acceptLanguage:e.headers.get("accept-language")||void 0,acceptEncoding:e.headers.get("accept-encoding")||void 0}}let n=new i},35860:(e,t,s)=>{s.d(t,{BI:()=>h,Iy:()=>y,Qd:()=>d,VF:()=>g,p8:()=>u,v1:()=>p});var r=s(59457),i=s.n(r);let a={LOGIN:{windowMs:9e5,maxRequests:5},CHAT:{windowMs:6e4,maxRequests:30},API_GENERAL:{windowMs:9e5,maxRequests:100},UPLOAD:{windowMs:36e5,maxRequests:10},ADMIN:{windowMs:6e4,maxRequests:20}},n=new(i())({stdTTL:0}),c=new(i())({stdTTL:3600});class o{constructor(e,t="rl"){this.cache=n,this.config=e,this.keyPrefix=t}async checkRateLimit(e){let t=`${this.keyPrefix}:${e}`,s=Date.now(),r=this.cache.get(t);return!r||s>=r.resetTime?(r={count:1,resetTime:s+this.config.windowMs,firstRequest:s},this.cache.set(t,r,this.config.windowMs/1e3),{allowed:!0,remainingRequests:this.config.maxRequests-1,resetTime:r.resetTime}):(r.count++,this.cache.set(t,r,Math.ceil((r.resetTime-s)/1e3)),r.count>this.config.maxRequests)?{allowed:!1,remainingRequests:0,resetTime:r.resetTime,retryAfter:Math.ceil((r.resetTime-s)/1e3)}:{allowed:!0,remainingRequests:this.config.maxRequests-r.count,resetTime:r.resetTime}}async recordRequest(e,t=!0){if(t&&this.config.skipSuccessfulRequests||!t&&this.config.skipFailedRequests)return}}class l{constructor(){this.cache=c}blockIp(e,t,s=36e5){let r={reason:t,blockedAt:Date.now(),attempts:1};this.cache.set(`blocked:${e}`,r,s/1e3)}isBlocked(e){let t=this.cache.get(`blocked:${e}`);return t?{blocked:!0,reason:t.reason,blockedAt:t.blockedAt}:{blocked:!1}}unblockIp(e){return this.cache.del(`blocked:${e}`)>0}incrementAttempts(e){let t=this.cache.get(`blocked:${e}`);return t?(t.attempts++,this.cache.set(`blocked:${e}`,t),t.attempts):0}getBlockedIps(){return this.cache.keys().filter(e=>e.startsWith("blocked:")).map(e=>({ip:e.replace("blocked:",""),entry:this.cache.get(e)}))}}let d=new o(a.LOGIN,"login"),u=new o(a.CHAT,"chat"),g=new o(a.API_GENERAL,"api");new o(a.UPLOAD,"upload");let p=new o(a.ADMIN,"admin"),h=new l;async function y(e,t,s){let r=function(e){let t=e.headers.get("x-forwarded-for"),s=e.headers.get("x-real-ip"),r=e.headers.get("cf-connecting-ip");return t?t.split(",")[0].trim():s||r||e.ip||"unknown"}(e),i=s||r,a=h.isBlocked(r);if(a.blocked)return{allowed:!1,headers:{"X-RateLimit-Blocked":"true","X-RateLimit-Block-Reason":a.reason||"IP blocked"},retryAfter:3600};let n=await t.checkRateLimit(i),c={"X-RateLimit-Limit":t.config.maxRequests.toString(),"X-RateLimit-Remaining":n.remainingRequests.toString(),"X-RateLimit-Reset":Math.ceil(n.resetTime/1e3).toString()};return!n.allowed&&n.retryAfter&&(c["Retry-After"]=n.retryAfter.toString()),{allowed:n.allowed,headers:c,retryAfter:n.retryAfter}}}};