"use strict";exports.id=533,exports.ids=[533],exports.modules={11826:(e,t,s)=>{s.d(t,{So:()=>p,ed:()=>o,sd:()=>u,wX:()=>l,y_:()=>c});var r=s(81304),i=s(83378),n=s(83178);async function a(e,t){return r.ZP.compare(e,t)}async function o(e){let t=Math.random().toString(36).substring(2)+Date.now().toString(36),s=new Date(Date.now()+2592e6);return(0,i.cookies)().set("session-token",t,{expires:s,httpOnly:!0,secure:!0,sameSite:"lax",path:"/"}),t}async function c(){try{let e=i.cookies().get("session-token")?.value;if(!e)return null;let t=await d(e);if(!t)return null;let s=await n._.user.findUnique({where:{id:t},select:{id:!0,email:!0,name:!0,image:!0,createdAt:!0,updatedAt:!0}});if(!s)return null;return{user:s,expires:new Date(Date.now()+2592e6)}}catch(e){return console.error("Error getting current session:",e),null}}async function l(e,t){let s=new Date(Date.now()+2592e6);await n._.session.create({data:{sessionToken:e,userId:t,expires:s}})}async function d(e){try{let t=await n._.session.findUnique({where:{sessionToken:e}});if(!t||t.expires<new Date)return t&&await n._.session.delete({where:{sessionToken:e}}),null;return t.userId}catch(e){return console.error("Error getting user from token:",e),null}}async function u(){let e=i.cookies().get("session-token")?.value;if(e)try{await n._.session.delete({where:{sessionToken:e}})}catch(e){}(0,i.cookies)().set("session-token","",{expires:new Date(0),httpOnly:!0,secure:!0,sameSite:"lax",path:"/"})}async function g(e){return n._.user.findUnique({where:{email:e}})}async function p(e,t){let s=await g(e);return s&&s.password&&await a(t,s.password)?{id:s.id,email:s.email,name:s.name,image:s.image,createdAt:s.createdAt,updatedAt:s.updatedAt}:null}},83178:(e,t,s)=>{s.d(t,{_:()=>i});var r=s(53524);let i=globalThis.prisma??new r.PrismaClient},92896:(e,t,s)=>{s.d(t,{XQ:()=>n,rO:()=>a});var r=s(83178);class i{async logActivity(e){try{await r._.auditLog.create({data:{userId:e.userId||null,action:e.action,resource:e.resource,details:{...e.details,success:e.success,errorMessage:e.errorMessage,responseTime:e.responseTime},ipAddress:e.ip,userAgent:e.userAgent,createdAt:new Date}})}catch(e){console.error("Failed to log activity:",e)}}async logSecurityEvent(e){try{await r._.securityEvent.create({data:{type:e.type,severity:e.severity,ipAddress:e.ip,userAgent:e.userAgent,userId:e.userId||null,description:e.description,metadata:e.metadata,createdAt:new Date}}),await this.logActivity({ip:e.ip,userAgent:e.userAgent,userId:e.userId,action:"security_event",resource:"system",details:{type:e.type,severity:e.severity,description:e.description,metadata:e.metadata},success:!1})}catch(e){console.error("Failed to log security event:",e)}}async analyzeIpActivity(e,t=60){try{let s=new Date(Date.now()-6e4*t),i=await r._.auditLog.findMany({where:{ipAddress:e,createdAt:{gte:s}},select:{action:!0,resource:!0,details:!0,createdAt:!0},orderBy:{createdAt:"desc"}}),n=i.length,a=i.filter(e=>e.details&&"object"==typeof e.details&&"success"in e.details&&!1===e.details.success).length,o=new Set(i.map(e=>`${e.action}:${e.resource}`)).size,c=0;n>100?c+=3:n>50?c+=2:n>20&&(c+=1);let l=n>0?a/n:0;if(l>.5?c+=4:l>.3?c+=2:l>.1&&(c+=1),o>20?c+=2:o>10&&(c+=1),i.length>=2){let e=[];for(let t=1;t<i.length;t++){let s=i[t-1].createdAt.getTime()-i[t].createdAt.getTime();e.push(s)}let t=e.reduce((e,t)=>e+t,0)/e.length;t<1e3?c+=3:t<5e3&&(c+=1)}let d=c>=5;return{totalRequests:n,failedRequests:a,uniqueEndpoints:o,suspiciousActivity:d,riskScore:Math.min(c,10)}}catch(e){return console.error("Failed to analyze IP activity:",e),{totalRequests:0,failedRequests:0,uniqueEndpoints:0,suspiciousActivity:!1,riskScore:0}}}async getIpGeolocation(e){try{if("unknown"===e||"127.0.0.1"===e||e.startsWith("192.168.")||e.startsWith("10."))return{country:"Local",region:"Local",city:"Local"};let t=new AbortController,s=setTimeout(()=>t.abort(),5e3),r=await fetch(`https://ipapi.co/${e}/json/`,{signal:t.signal});if(clearTimeout(s),!r.ok)throw Error(`HTTP ${r.status}`);let i=await r.json();return{country:i.country_name,region:i.region,city:i.city,isp:i.org,isVpn:i.connection?.type==="vpn"}}catch(e){return console.error("Failed to get IP geolocation:",e),{}}}async getRecentSecurityEvents(e=50){try{return await r._.securityEvent.findMany({take:e,orderBy:{createdAt:"desc"},select:{id:!0,type:!0,severity:!0,ipAddress:!0,userAgent:!0,description:!0,createdAt:!0,metadata:!0}})}catch(e){return console.error("Failed to get recent security events:",e),[]}}async getSuspiciousIps(){try{let e=new Date(Date.now()-864e5),t=await r._.auditLog.groupBy({by:["ipAddress"],where:{createdAt:{gte:e},ipAddress:{not:null}},_count:{id:!0},_max:{createdAt:!0}}),s=[];for(let e of t){if(!e.ipAddress)continue;let t=await this.analyzeIpActivity(e.ipAddress,1440);t.suspiciousActivity&&s.push({ip:e.ipAddress,riskScore:t.riskScore,totalRequests:t.totalRequests,failedRequests:t.failedRequests,lastActivity:e._max.createdAt})}return s.sort((e,t)=>t.riskScore-e.riskScore)}catch(e){return console.error("Failed to get suspicious IPs:",e),[]}}}function n(e){let t=e.headers.get("x-forwarded-for"),s=e.headers.get("x-real-ip"),r=e.headers.get("cf-connecting-ip"),i="unknown";return t?i=t.split(",")[0].trim():s?i=s:r?i=r:e.ip&&(i=e.ip),{ip:i,userAgent:e.headers.get("user-agent")||"unknown",referer:e.headers.get("referer")||void 0,origin:e.headers.get("origin")||void 0,acceptLanguage:e.headers.get("accept-language")||void 0,acceptEncoding:e.headers.get("accept-encoding")||void 0}}let a=new i},85698:(e,t,s)=>{s.d(t,{BI:()=>h,Iy:()=>w,Qd:()=>d,VF:()=>g,p8:()=>u,v1:()=>p});var r=s(39103),i=s.n(r);let n={LOGIN:{windowMs:9e5,maxRequests:5},CHAT:{windowMs:6e4,maxRequests:30},API_GENERAL:{windowMs:9e5,maxRequests:100},UPLOAD:{windowMs:36e5,maxRequests:10},ADMIN:{windowMs:6e4,maxRequests:20}},a=new(i())({stdTTL:0}),o=new(i())({stdTTL:3600});class c{constructor(e,t="rl"){this.cache=a,this.config=e,this.keyPrefix=t}async checkRateLimit(e){let t=`${this.keyPrefix}:${e}`,s=Date.now(),r=this.cache.get(t);return!r||s>=r.resetTime?(r={count:1,resetTime:s+this.config.windowMs,firstRequest:s},this.cache.set(t,r,this.config.windowMs/1e3),{allowed:!0,remainingRequests:this.config.maxRequests-1,resetTime:r.resetTime}):(r.count++,this.cache.set(t,r,Math.ceil((r.resetTime-s)/1e3)),r.count>this.config.maxRequests)?{allowed:!1,remainingRequests:0,resetTime:r.resetTime,retryAfter:Math.ceil((r.resetTime-s)/1e3)}:{allowed:!0,remainingRequests:this.config.maxRequests-r.count,resetTime:r.resetTime}}async recordRequest(e,t=!0){if(t&&this.config.skipSuccessfulRequests||!t&&this.config.skipFailedRequests)return}}class l{constructor(){this.cache=o}blockIp(e,t,s=36e5){let r={reason:t,blockedAt:Date.now(),attempts:1};this.cache.set(`blocked:${e}`,r,s/1e3)}isBlocked(e){let t=this.cache.get(`blocked:${e}`);return t?{blocked:!0,reason:t.reason,blockedAt:t.blockedAt}:{blocked:!1}}unblockIp(e){return this.cache.del(`blocked:${e}`)>0}incrementAttempts(e){let t=this.cache.get(`blocked:${e}`);return t?(t.attempts++,this.cache.set(`blocked:${e}`,t),t.attempts):0}getBlockedIps(){return this.cache.keys().filter(e=>e.startsWith("blocked:")).map(e=>({ip:e.replace("blocked:",""),entry:this.cache.get(e)}))}}let d=new c(n.LOGIN,"login"),u=new c(n.CHAT,"chat"),g=new c(n.API_GENERAL,"api");new c(n.UPLOAD,"upload");let p=new c(n.ADMIN,"admin"),h=new l;async function w(e,t,s){let r=function(e){let t=e.headers.get("x-forwarded-for"),s=e.headers.get("x-real-ip"),r=e.headers.get("cf-connecting-ip");return t?t.split(",")[0].trim():s||r||e.ip||"unknown"}(e),i=s||r,n=h.isBlocked(r);if(n.blocked)return{allowed:!1,headers:{"X-RateLimit-Blocked":"true","X-RateLimit-Block-Reason":n.reason||"IP blocked"},retryAfter:3600};let a=await t.checkRateLimit(i),o={"X-RateLimit-Limit":t.config.maxRequests.toString(),"X-RateLimit-Remaining":a.remainingRequests.toString(),"X-RateLimit-Reset":Math.ceil(a.resetTime/1e3).toString()};return!a.allowed&&a.retryAfter&&(o["Retry-After"]=a.retryAfter.toString()),{allowed:a.allowed,headers:o,retryAfter:a.retryAfter}}}};